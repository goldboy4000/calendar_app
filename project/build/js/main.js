!function(t){function n(){this.events={}}n.prototype.subscribe=function(t,n){this.events[t]||(this.events[t]=[]),this.events[t].push(n)},n.prototype.dispatch=function(t,n){this.events[t]&&this.events[t].length&&this.events[t].map(function(t){t(n)})},n.prototype.unsubscribe=function(t,n){},t.eventManager=new n}(window);
!function(e){"use strict";var n=function(){new LocalizationLoader("data.json"),new WeatherController("Minsk","by","metric","ru"),new MenuController("#menu_container","show-button","month-selector","year-selector"),new CalendarController("#calendar_nav_container","#calendar_container")},t=function(){eventManager.dispatch("exit_from_page")};e.addEventListener("load",n),e.addEventListener("pagehide",t)}(window);
function ExtendedDate(){return new Date}ExtendedDate.prototype=Date.prototype,ExtendedDate.prototype.constructor=ExtendedDate,ExtendedDate.prototype.daysInMonth=function(){return 32-new Date(this.getFullYear(),this.getMonth(),32).getDate()},ExtendedDate.prototype.fullWeeksInMonth=function(){var t=new Date(this.getFullYear(),this.getMonth(),1).getDay();t=t||7;var e=t-1+this.daysInMonth();return Number(Math.floor(e/7)+Boolean(e%7))};
function LocalizationLoader(t){this.localization="ru",this.source=t,this.init()}LocalizationLoader.prototype.init=function(){this.setupHandlers().subscribeHandlers()},LocalizationLoader.prototype.setupHandlers=function(){return this.langChangeHandler=this.langChange.bind(this),this},LocalizationLoader.prototype.subscribeHandlers=function(){return eventManager.subscribe("lang_changed",this.langChangeHandler),this},LocalizationLoader.prototype.load=function(){var t=new XMLHttpRequest;t.addEventListener("readystatechange",this.readyStateChangeHandler.bind(this)),t.open("GET",this.source,!0),t.send()},LocalizationLoader.prototype.parse=function(t){try{var a=JSON.parse(t)}catch(t){return null}return a[this.localization+"Lang"]},LocalizationLoader.prototype.langChange=function(t){this.localization=t,this.load()},LocalizationLoader.prototype.readyStateChangeHandler=function(t){if(4===t.target.readyState)if(200!==t.target.status)console.log("status = "+t.target.status);else{var a=this.parse(t.target.responseText);a&&eventManager.dispatch("localization_load",{namesOfDays:a.namesOfDays,namesOfMonths:a.namesOfMonths})}};
function Modal(t){this.modal=document.querySelector(t),this.init()}Modal.prototype.init=function(){this.setupHandlers(),this.modal.querySelector("#success_button").disabled=!0},Modal.prototype.setupHandlers=function(){this.modal.addEventListener("click",this.modalClickHandler.bind(this)),this.modal.addEventListener("keyup",this.modalKeyUpHandler.bind(this))},Modal.prototype.modalClickHandler=function(t){var e=t.target;"success_button"===e.id&&(eventManager.dispatch("modal_success",this.modal.querySelector("#text_input").value),this.hide()),"cancel_button"!==e.id&&"close_button"!==e.id||this.hide()},Modal.prototype.modalKeyUpHandler=function(t){var e=t.target;"text_input"===e.id&&(this.modal.querySelector("#success_button").disabled=!e.value)},Modal.prototype.show=function(t){this.modal.querySelector("#title").innerHTML=t||"New Event",this.modal.classList.add("is-active")},Modal.prototype.hide=function(){this.modal.querySelector("#text_input").value="",this.modal.classList.remove("is-active"),this.modal.querySelector("#success_button").disabled=!0};
function Task(t,e){this.task=t,this.date=e,this.id=this.generateID()}Task.prototype.getInstance=function(){var t=document.createElement("li");return t.appendChild(utils.getTag(this.id,"task","is-primary","is-small",this.task,!0)),t},Task.prototype.generateID=function(){var t=0;return function(){return t++}}();
!function(e){function t(){}t.prototype.getColumn=function(e,t){var n=document.createElement("div");return n.className="column",t&&n.classList.add(t),n.appendChild(e),n},t.prototype.getTag=function(e,t,n,a,r,o){var c=document.createElement("span");c.className="tag",c.classList.add(t),c.classList.add(n),c.classList.add(a),c.setAttribute("id",e);var d=document.createTextNode(r);if(c.appendChild(d),o){var i=document.createElement("button");i.className="delete is-small",i.setAttribute("id","delete"),c.appendChild(i)}return c},t.prototype.getButton=function(e,t,n){var a=document.createElement("a"),r=document.createElement("span");r.className="icon is-large",r.setAttribute("id",e),a.appendChild(r);var o=document.createElement("i");return o.className=n,o.innerHTML=t,r.appendChild(o),a},t.prototype.getSimpleButton=function(e,t,n){var a=document.createElement("a");a.className="button",a.classList.add(n),a.setAttribute("id",e);var r=document.createTextNode(t);return a.appendChild(r),a},t.prototype.getSelector=function(e){var t=document.createElement("select");return t.setAttribute("id",e),t},t.prototype.findChild=function(e,t){for(var n=0;n<e.children.length;n++)if(e.children[n].tagName===t.toUpperCase())return e.children[n];return null},t.prototype.getOption=function(e,t){var n=document.createElement("option");return n.value=e,n.innerHTML=t,n},e.utils=new t}(window);
function CalendarController(e,a){this.model=new CalendarModel,this.view=new CalendarView(this.model,e,a),this.setupHandlers().subscribeHandlers(),this.model.init()}CalendarController.prototype.setupHandlers=function(){return this.tasksLoadedHandler=this.tasksLoaded.bind(this),this.addTaskHandler=this.addTask.bind(this),this.taskAddedHandler=this.taskAdded.bind(this),this.removeTaskHandler=this.removeTask.bind(this),this.taskRemovedHandler=this.taskRemoved.bind(this),this.monthPreviousHandler=this.monthPrevious.bind(this),this.monthNextHandler=this.monthNext.bind(this),this.dateChangedHandler=this.dateChanged.bind(this),this.changeDayHandler=this.changeDay.bind(this),this.dayChangedHandler=this.dayChanged.bind(this),this.modalSuccessHandler=this.modalSuccess.bind(this),this.localizationLoadHandler=this.localizationLoad.bind(this),this.calendarLangChangedHandler=this.calendarLangChanged.bind(this),this.exitFromPageHandler=this.exitFromPage.bind(this),this},CalendarController.prototype.subscribeHandlers=function(){eventManager.subscribe("tasks_loaded",this.tasksLoadedHandler),eventManager.subscribe("add_task",this.addTaskHandler),eventManager.subscribe("task_added",this.taskAddedHandler),eventManager.subscribe("remove_task",this.removeTaskHandler),eventManager.subscribe("task_removed",this.taskRemovedHandler),eventManager.subscribe("month_previous",this.monthPreviousHandler),eventManager.subscribe("month_next",this.monthNextHandler),eventManager.subscribe("date_changed",this.dateChangedHandler),eventManager.subscribe("change_day",this.changeDayHandler),eventManager.subscribe("day_changed",this.dayChangedHandler),eventManager.subscribe("modal_success",this.modalSuccessHandler),eventManager.subscribe("localization_load",this.localizationLoadHandler),eventManager.subscribe("calendar_lang_change",this.calendarLangChangedHandler),eventManager.subscribe("exit_from_page",this.exitFromPageHandler)},CalendarController.prototype.tasksLoaded=function(){this.view.render()},CalendarController.prototype.addTask=function(e){this.model.addTask(e)},CalendarController.prototype.taskAdded=function(){this.view.render()},CalendarController.prototype.removeTask=function(e){this.model.removeTask(e)},CalendarController.prototype.taskRemoved=function(){this.view.render()},CalendarController.prototype.monthPrevious=function(){this.model.previous()},CalendarController.prototype.monthNext=function(){this.model.next()},CalendarController.prototype.dateChanged=function(e){e?this.view.render(e.month,e.year):this.view.render()},CalendarController.prototype.changeDay=function(e){this.model.setDay(e)},CalendarController.prototype.dayChanged=function(){this.view.showModal()},CalendarController.prototype.modalSuccess=function(e){this.view.modalSuccessHandler(e)},CalendarController.prototype.localizationLoad=function(e){this.model.setLang(e)},CalendarController.prototype.calendarLangChanged=function(){this.view.render()},CalendarController.prototype.exitFromPage=function(){this.model.saveTasksToStorage()};
function MenuController(e,n,t,o){this.model=new MenuModel,this.view=new MenuView(this.model,e,n,t,o),this.setupHandlers().subscribeHandlers()}MenuController.prototype.setupHandlers=function(){return this.changeSelectedHandler=this.changeSelected.bind(this),this.changeLocalizationHandler=this.changeLocalization.bind(this),this.localizationLoadHandler=this.localizationLoad.bind(this),this.menuLangChangeHandler=this.menuLangChange.bind(this),this},MenuController.prototype.subscribeHandlers=function(){return eventManager.subscribe("change_selected",this.changeSelectedHandler),eventManager.subscribe("change_lang",this.changeLocalizationHandler),eventManager.subscribe("localization_load",this.localizationLoadHandler),eventManager.subscribe("menu_lang_change",this.menuLangChangeHandler),this},MenuController.prototype.changeSelected=function(e){this.model.setSelectedMonth(e)},MenuController.prototype.changeLocalization=function(e){this.model.setLocalization(e)},MenuController.prototype.localizationLoad=function(e){this.model.setNamesOfMonths(e.namesOfMonths)},MenuController.prototype.menuLangChange=function(){this.view.fillMonthSelector()};
function WeatherController(e,t,r,o){this.model=new WeatherModel(e,t,r,o),this.view=new WeatherView(this.model),this.init()}WeatherController.prototype.init=function(){return this.setupHandlers().subscribeHandlers(),this},WeatherController.prototype.setupHandlers=function(){return this.forecastRequestHandler=this.forecastRequest.bind(this),this.forecastLoadedHandler=this.forecastLoaded.bind(this),this},WeatherController.prototype.subscribeHandlers=function(){return eventManager.subscribe("forecast_request",this.forecastRequestHandler),eventManager.subscribe("forecast_loaded",this.forecastLoadedHandler),this},WeatherController.prototype.forecastRequest=function(e){this.model.getInfo(e)},WeatherController.prototype.forecastLoaded=function(e){this.view.render(e)};
function CalendarView(e,t,n){this.model=e,this.navigationContainer=t,this.calendarContainer=n,this.id="calendar",this.selector="#"+this.id,this.modal=new Modal(".modal"),this.init()}CalendarView.prototype.init=function(){this.setupHandlers()},CalendarView.prototype.setupHandlers=function(){return document.querySelector(this.navigationContainer).addEventListener("click",this.calendarNavClickHandler.bind(this)),document.querySelector(this.calendarContainer).addEventListener("click",this.calendarClickHandler.bind(this)),this},CalendarView.prototype.renderNavigationPanel=function(){var e=document.querySelector(this.navigationContainer);e.innerHTML="",e.appendChild(this.getNavigationElement(this.model.namesOfMonths[this.model.month]+" "+this.model.year))},CalendarView.prototype.renderCalendar=function(){var e=document.querySelector(this.calendarContainer),t=e.querySelector(this.selector);t&&e.removeChild(t),e.appendChild(this.getCalendarElement())},CalendarView.prototype.renderTasks=function(){var e=this.model.tasks[this.model.month+"_"+this.model.year];e&&e.forEach(function(e){var t=document.querySelector(this.selector);if(e instanceof Task){var n=t.querySelector("#day"+e.date.getDate()),a=n.querySelector(".task_list");a||(a=this.getTaskList(),n.insertBefore(a,n.childNodes[0])),a.appendChild(e.getInstance())}}.bind(this))},CalendarView.prototype.render=function(e,t){return this.model.month=isNaN(+e)?this.model.month:+e,this.model.year=isNaN(+t)?this.model.year:+t,this.renderNavigationPanel(),this.renderCalendar(),this.renderTasks(),this},CalendarView.prototype.getNavigationElement=function(e){var t=document.createElement("div");return t.className="columns",t.appendChild(utils.getColumn(utils.getButton("previous","","fa fa-arrow-circle-o-left"))),t.appendChild(utils.getColumn(utils.getTag("date","title","is-primary","is-large",e),"is-three-quarters")),t.appendChild(utils.getColumn(utils.getButton("next","","fa fa-arrow-circle-o-right"))),t},CalendarView.prototype.getHeader=function(e){for(var t=document.createElement("tr"),n=0;n<e.length;n++)t.appendChild(this.getHeaderCell(e[n]));var a=document.createElement("thead");return a.appendChild(t),a},CalendarView.prototype.getHeaderCell=function(e){var t=document.createElement("th");return t.innerHTML=e,t},CalendarView.prototype.getBody=function(e,t){for(var n=document.createElement("tbody"),a=new Date(e,t),i=a.getDay()||7,r=a.daysInMonth(),o=1,d=[],l=!0,s=0;s<a.fullWeeksInMonth();s++){d[s]=document.createElement("tr"),n.appendChild(d[s]);for(var c=1;c<=7;c++)column=document.createElement("td"),c<i&&l||o>r?column.innerHTML="&nbsp":(column.setAttribute("id","day"+o),column.innerHTML=o++,l=!1),d[s].appendChild(column)}return n},CalendarView.prototype.getCalendarElement=function(){var e=document.createElement("table");return e.className="table is-bordered",e.setAttribute("id",this.id),e.appendChild(this.getHeader(this.model.namesOfDays)),e.appendChild(this.getBody(this.model.year,this.model.month)),e},CalendarView.prototype.getTaskList=function(){var e=document.createElement("ul");return e.setAttribute("class","task_list"),e},CalendarView.prototype.calendarNavClickHandler=function(e){for(var t=e.target;t.id!==this.navigationContainer.slice(1);){if("previous"===t.id){eventManager.dispatch("month_previous");break}if("next"===t.id){eventManager.dispatch("month_next");break}t=t.parentNode}},CalendarView.prototype.calendarClickHandler=function(e){var t=e.target;if("delete"===t.id){var n=+t.closest(".task").id;return void(isNaN(n)||eventManager.dispatch("remove_task",n))}var a=t.closest("td");a&&"&nbsp;"!==a.innerHTML&&eventManager.dispatch("change_day",a.id.slice(3))},CalendarView.prototype.showModal=function(){this.modal.show("Event on "+this.model.day+" "+this.model.namesOfMonths[this.model.month]+" "+this.model.year)},CalendarView.prototype.modalSuccessHandler=function(e){eventManager.dispatch("add_task",e)};
function MenuView(e,t,n,i,o){this.model=e,this.selector=t,this.el=document.querySelector(this.selector),this.buttonId=n,this.monthSelectorId=i,this.yearSelectorId=o,this.init().render()}MenuView.prototype.init=function(){return this.el.addEventListener("click",this.showButtonClickHandler.bind(this)),this.el.addEventListener("change",this.selectorChangeHandler.bind(this)),this},MenuView.prototype.fillMonthSelector=function(){var e=document.getElementById(this.monthSelectorId);e.innerHTML="",e.appendChild(utils.getOption(-1,"-choose month-"));for(var t=0;t<this.model.namesOfMonths.length;t++)e.appendChild(utils.getOption(t,this.model.namesOfMonths[t]));e.selectedIndex=this.model.selectedMonth},MenuView.prototype.toggleLocButtons=function(){var e=document.getElementById("ru-lang-button"),t=document.getElementById("en-lang-button");"ru"===this.model.localization?(e.classList.add("is-outlined"),t.classList.remove("is-outlined")):(e.classList.remove("is-outlined"),t.classList.add("is-outlined"))},MenuView.prototype.renderButton=function(){var e=utils.getSimpleButton(this.buttonId,"Show","is-primary");e.setAttribute("disabled",""),this.el.appendChild(e)},MenuView.prototype.renderSelectors=function(){var e=utils.getSelector(this.monthSelectorId);this.el.appendChild(e),this.fillMonthSelector();var t=utils.getSelector(this.yearSelectorId);t.appendChild(utils.getOption(-1,"-choose year-"));for(var n=(new Date).getFullYear();n>=1900;n--)t.appendChild(utils.getOption(n,n));this.el.appendChild(t)},MenuView.prototype.renderLocalizationMenu=function(){var e=utils.getSimpleButton("ru-lang-button","ru","is-info");e.addEventListener("click",this.locClickHandler.bind(this));var t=utils.getSimpleButton("en-lang-button","en","is-info");t.addEventListener("click",this.locClickHandler.bind(this)),this.el.appendChild(e),this.el.appendChild(t),this.toggleLocButtons()},MenuView.prototype.render=function(){this.el.innerHTML="",this.renderButton(),this.renderSelectors(),this.renderLocalizationMenu()},MenuView.prototype.showButtonClickHandler=function(e){var t=e.target;if(t.id===this.buttonId&&!t.hasAttribute("disabled")){var n=document.getElementById(this.monthSelectorId),i=document.getElementById(this.yearSelectorId);eventManager.dispatch("date_changed",{month:n[n.selectedIndex].value,year:i[i.selectedIndex].value})}},MenuView.prototype.selectorChangeHandler=function(e){var t=document.getElementById(this.buttonId),n=document.getElementById(this.monthSelectorId),i=document.getElementById(this.yearSelectorId);eventManager.dispatch("change_selected",n.selectedIndex),0!==n.selectedIndex&&0!==i.selectedIndex?t.removeAttribute("disabled"):t.setAttribute("disabled","")},MenuView.prototype.locClickHandler=function(e){eventManager.dispatch("change_lang",e.target.id.slice(0,2)),this.toggleLocButtons()};
function WeatherView(e){this.model=e,this.element=document.querySelector("#weather-box"),this.init()}WeatherView.prototype.init=function(){this.setupHandlers()},WeatherView.prototype.setupHandlers=function(){this.element.addEventListener("click",this.clickHandler.bind(this))},WeatherView.prototype.render=function(e){if(e.list){this.element.removeChild(this.element.querySelector(".media"));var t=new Date,a=0;e.list.forEach(function(e){var n=new Date(e.dt_txt);t.getHours()>12&&!a&&(this.element.appendChild(this.renderForecast(this.getForecastObject(e))),a++),12===n.getHours()&&a<3&&(this.element.appendChild(this.renderForecast(this.getForecastObject(e))),a++)}.bind(this))}else this.element.appendChild(this.renderForecast(this.getForecastObject(e)))},WeatherView.prototype.renderForecast=function(e){var t=document.createElement("img");t.src=e.image,t.alt="Image";var a=document.createElement("figure");a.className="image is-64x64",a.appendChild(t);var n=document.createElement("div");n.className="media-left",n.appendChild(a);var r=document.createElement("span");r.innerHTML=e.temperature;var i=document.createElement("span");i.innerHTML=e.city;var c=document.createElement("span");c.innerHTML=e.description;var d=document.createElement("br"),o=document.createTextNode(" "),s=document.createElement("div");s.className="content",s.appendChild(r),s.appendChild(o),s.appendChild(i),s.appendChild(d),s.appendChild(c);var p=document.createElement("div");p.className="media-content",p.appendChild(s);var l=document.createElement("article");return l.className="media",l.appendChild(n),l.appendChild(p),l},WeatherView.prototype.getForecastObject=function(e){var t={};e.weather[0]&&(t.image="http://openweathermap.org/img/w/"+e.weather[0].icon+".png",t.description=e.weather[0].description);var a="";return+e.main.temp>0?a="+":+e.main.temp<0&&(a="-"),t.temperature=a+Math.floor(e.main.temp)+"℃",t.city=e.name||"",t},WeatherView.prototype.clickHandler=function(e){"close-weather"===e.target.id&&(this.element.style.display="none"),"forecast-three-days"===e.target.id&&(eventManager.dispatch("forecast_request","http://api.openweathermap.org/data/2.5/forecast?q="),e.target.style.display="none")};
function CalendarModel(t,a){var e=["ПН","ВТ","СР","ЧТ","ПТ","СБ","ВС"];this.day=(new Date).getDate(),this.month=isNaN(+t)?(new Date).getMonth():+t,this.year=isNaN(+a)?(new Date).getFullYear():+a,this.tasks={},this.namesOfDays=e,this.namesOfMonths=NAMES_OF_MONTHS,this.toJSON=function(){return this.tasks},this.tasksLocalStorageKey="tasks"}var NAMES_OF_MONTHS=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];CalendarModel.prototype.init=function(){this.loadTasksFromStorage()},CalendarModel.prototype.setDay=function(t){this.day=t,eventManager.dispatch("day_changed")},CalendarModel.prototype.setLang=function(t){this.namesOfDays=t.namesOfDays,this.namesOfMonths=t.namesOfMonths,eventManager.dispatch("calendar_lang_change")},CalendarModel.prototype.addTask=function(t){var a=new Task(t,new Date(this.year,this.month,this.day)),e=this.month+"_"+this.year;this.tasks[e]||(this.tasks[e]=[]),this.tasks[e].push(a),eventManager.dispatch("task_added")},CalendarModel.prototype.removeTask=function(t){if(this.tasks[this.month+"_"+this.year]){this.tasks[this.month+"_"+this.year].forEach(function(a,e,s){a instanceof Task&&a.id===t&&s.splice(e,1)}.bind(this))}eventManager.dispatch("task_removed")},CalendarModel.prototype.previous=function(){-1==--this.month&&(this.month=11,this.year--),eventManager.dispatch("date_changed")},CalendarModel.prototype.next=function(){12==++this.month&&(this.month=0,this.year++),eventManager.dispatch("date_changed")},CalendarModel.prototype.loadTasksFromStorage=function(){var t=localStorage.getItem(this.tasksLocalStorageKey);try{var a=JSON.parse(t);for(var e in a)this.tasks[e]=[],a[e].forEach(function(t){var a=new Task(t.task,new Date(t.date));this.tasks[e].push(a)}.bind(this))}catch(t){this.tasks={}}eventManager.dispatch("tasks_loaded")},CalendarModel.prototype.saveTasksToStorage=function(){localStorage.removeItem(this.tasksLocalStorageKey),localStorage.setItem(this.tasksLocalStorageKey,JSON.stringify(this))};
function MenuModel(){this.namesOfMonths=NAMES_OF_MONTHS,this.localization="ru",this.selectedMonth=0}MenuModel.prototype.setSelectedMonth=function(t){this.selectedMonth=t},MenuModel.prototype.setLocalization=function(t){this.localization=t,eventManager.dispatch("lang_changed",this.localization)},MenuModel.prototype.setNamesOfMonths=function(t){this.namesOfMonths=t,eventManager.dispatch("menu_lang_change")};
function WeatherModel(t,e,a,r){this.city=t||"Minsk",this.country=e||"by",this.units=a||"metric",this.lang=r||"ru",this.xhr=new XMLHttpRequest,this.init().getInfo()}WeatherModel.prototype.init=function(){return this.setupHandlers(),this},WeatherModel.prototype.setupHandlers=function(){return this.xhr.addEventListener("load",this.loadWeatherHandler.bind(this)),this},WeatherModel.prototype.getInfo=function(t){var e=t||"http://api.openweathermap.org/data/2.5/weather?q=";this.xhr.open("GET",e+this.city+","+this.country+"&APPID=fac89aa646dd8482a386ae7aa00fcdbb&units="+this.units+"&lang="+this.lang,!0),this.xhr.send()},WeatherModel.prototype.parse=function(t){try{var e=JSON.parse(t)}catch(t){return null}return e},WeatherModel.prototype.loadWeatherHandler=function(t){var e=t.target;if(200!==e.status)console.log("status = "+e.status);else{var a=this.parse(e.responseText);a&&eventManager.dispatch("forecast_loaded",a)}};